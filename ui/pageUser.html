<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="./style.css">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to ERS</title>
</head>

<body>
    <p id="pageContent"><!-- Our inserted content will go here --></p>

    <!-- This imports a script file, in this case it imports the exported scripts from that file -->
    <script src="./scripts/userConnection.js"></script>
    <script src="./scripts/reimbursementConnection.js"></script>

    <script>

        //First we grab the authToken from localStorage where we left it at login/register
        let authorizedUser = sessionStorage.getItem("username");
        console.log("authorizedUser: ", authorizedUser);//fact finding

        /*
        This is a self-invoking function, also known as IIFE, imediately invoked 
        function expression. To build one, wrap the function declaration in ()
        then add another pair of () at the end to act as the parameter list. Effectively
        as soon as the function is defined it is called.
        */
        (async function displayUser() {
            /*
            Now we make an API call to get our user data. The backend checks against the registered
            users for matching username, and returns the rest of the user object.
            */
            let response = await getUser(sessionStorage.getItem("username"));
            let json = await response.json();
            console.log("Response: ", response);//more fact finding
            console.log("Response JSON: ", json);//we should probably remove these later

            /*
            Now we do DOM manipulation. We get the paragraph element in the HTML above
            and append some HTML to it. This changes the DOM, and thus the browser renders 
            the new view.
            */
            let paragraph = document.getElementById("pageContent");
            paragraph.innerHTML += "<h1>Welcome, "
                + json.firstName
                + "</h1><br>"
                + json.lastName + ", " + json.firstName
                + "<br> username: " + json.username
                + "<br> email: " + json.email
                + "<br> unique user id: " + json.id;

            let body = document.getElementsByTagName("body")[0];
            
            body.innerHTML += "<table>"
                + "<tr><th>Request ID</th>" 
                + "<th>Status</th>"
                + "<th>Type</th>"
                + "<th>Description</th></tr></table>";

            await displayInfo(json.id);
        })(); //IIFE - Imediately Invoked Function Expression - self-invoking function.

        
    </script>

    <button type="button" onclick="submitRequest()">Submit a request</button>
    <button type="button" onclick="cancelRequest()">Cancel a request</button>
    <button type="button" onclick="editRequest()">Edit a request</button>
    <button type="button" onclick="logout()">Log out</button>



    <script>
        async function displayInfo(id) {
            let requests = await getReimbursementsUser(id);

            if (requests.status == 200){
                let rjs = await requests.json();
                console.log("Response: ", requests);
                console.log("Response JSON: ", rjs);

                let table = document.getElementsByTagName("table")[0];
                for(let i = 0; i < rjs.length; i++){
                    table.innerHTML += "<tr><td>"
                        + rjs[i].id + "</td><td>"
                        + rjs[i].status + "</td><td>"
                        + rjs[i].type + "</td><td>"
                        + rjs[i].description + "</td><td class ='btn'></td></tr>";

                        /*let btn = document.getElementsByClassName("btn")[i];
                        if(rjs[i].status == "Pending"){
                            btn.innerHTML += "<button type=\"button\" onclick=\"editRequest('Admin', \'" + json[i].id + "\')\">Promote to admin</button>"
                            + "<button type=\"button\" onclick=\"cancelRequest('Admin', \'" + json[i].id + "\')\">Promote to admin</button>";
                        }
                        else {

                        }*/
                }
            }
        }


        async function submitRequest() {
            let newStatus = "Pending";
            let newType = prompt("Press 1 for lodging, 2 for food, 3 for travel");

            if(newType == 1){
                newType = "Lodging";
            }
            else if(newType == 2){
                newType = "Food";
            }
            else if(newType == 3){
                newType = "Travel";
            }
            
            let newDesc = prompt("Enter your description");

            let response = await getUser(sessionStorage.getItem("username"));
            let json = await response.json();
            let id = json.id;

            newR = {
                status: newStatus,
                type: newType,
                description: newDesc,
                userID: id
            }

            let n = await newReimbursement(newR);

            window.location.href = "./pageUser.html";
        }

        async function cancelRequest() {
            let cancelID = prompt("Enter ID of the request you wish to cancel");
            let userID = sessionStorage.getItem("userid");

            let del = {
                user_id: userID,
                req_id: cancelID
            }

            let d = await deleteReimbursement(del);

            if(d.status == 412){
                window.alert("Invalid request ID");
            } else {
                window.location.href = "./pageUser.html";
            }
        }

        async function editRequest() {
            let editID = prompt("Enter ID of the request you want to edit");
            let user = sessionStorage.getItem("userid");

            let info = {
                req: editID,
                user: user
            }

            let req = await getReimbursement(info);

            if(req.status == 200){
                let json = await req.json();
                let eType = json.type;
                let eDesc = json.description;
                let eStatus = json.status;
                
                let choice = prompt("Press 1 to change type");
                if(choice == 1){
                    let newType = prompt("Press 1 for lodging, 2 for food, 3 for travel");

                    if(newType == 1){
                        eType = "Lodging";
                    }
                    else if(newType == 2){
                        eType = "Food";
                    }
                    else if(newType == 3){
                        eType = "Travel";
                    } 
                }

                choice = prompt("Press 1 to change description");
                if(choice == 1){
                    eDesc = prompt("Enter the new description");
                }

                let e = {
                    status: eStatus,
                    type: eType,
                    description: eDesc,
                    userID: user,
                    id: editID
                }

                let f = await updateReimbursement(e);
                window.location.href = "./pageUser.html";

            }
            else {
                window.alert("Invalid request ID");
            }
        }

        async function logout(){
            sessionStorage.clear();
            window.location.href= "./login.html";
        }

    </script>

</body>

</html>